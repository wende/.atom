var ptyjs = require("pty.js");
var Terminal = require("term.js");
var debounce = require("debounce");
var util = require("util");
var $ = require("atom").$;
var View = require("atom").View;
var path = require("path");
var keypather = require("keypather")();
var os = require("os");
// var EventEmitter = require('events').EventEmitter;
var __hasProp = ({}).hasOwnProperty;
var __extends = function __extends(child, parent) {
  for (var key in parent) {
    if (__hasProp.call(parent, key)) child[key] = parent[key];
  }function ctor() {
    this.constructor = child;
  }ctor.prototype = parent.prototype;child.prototype = new ctor();child.__super__ = parent.prototype;return child;
};
var last = function last(str) {
  return str[str.length - 1];
};

module.exports = TermView;

function TermView(opts) {
  opts = opts || {};
  this.opts = opts;
  opts.shell = process.env.SHELL || "bash";
  var editorPath = keypather.get(atom, "workspace.getEditorViews[0].getEditor().getPath()");
  opts.cwd = opts.cwd || atom.project.getPath() || editorPath || process.env.HOME || path.resolve(__dirname, "..", "..", "..", ".."); // back out of .atom/packages/term/lib
  TermView.__super__.constructor.apply(this, arguments);
}

// util.inherits(TermView, EventEmitter);
__extends(TermView, View);

TermView.content = function () {
  return this.div({ "class": "term" });
};

TermView.prototype.initialize = function (state) {
  this.state = state;
  var opts = this.opts;
  var dims = this.getDimensions();
  var pty = this.pty = ptyjs.spawn(opts.shell, [], {
    name: "xterm-color",
    cols: dims.cols,
    rows: dims.rows,
    cwd: opts.cwd,
    env: process.env
  });
  var term = this.term = new Terminal({
    cols: dims.cols,
    rows: dims.rows,
    useStyle: true,
    screenKeys: true });
  term.on("data", pty.write.bind(pty));
  term.open(this[0]);
  if (this.opts.runCommand) {
    pty.write(this.opts.runCommand + os.EOL);
  }
  pty.pipe(term);
  term.end = this.destroy.bind(this);
  term.focus();

  this.attachEvents();

  window.term = term;
  window.pty = pty;
};

TermView.prototype.getTitle = function () {
  return "(" + last(this.opts.shell.split("/")) + ")";
};

TermView.prototype.attachEvents = function () {
  this.resizeToPane = this.resizeToPane.bind(this);
  this.attachResizeEvents();
};

TermView.prototype.attachResizeEvents = function () {
  // call immediately (after timeout) for initial sizing
  var self = this;
  setTimeout(function () {
    self.resizeToPane.bind(self);
  }, 10);

  // focus
  this.on("focus", this.resizeToPane);
  var parentPane = atom.workspace.getActivePane();
  // atom missing: no item-activated event :-/, use interval for now
  // parentPane.on('item-activated', function (item) {
  //   if (item === self) self.resizeToPane();
  // });
  this.resizeInterval = setInterval(this.resizeToPane.bind(this), 50);
  // resize
  var resizeHandlers = this.resizeHandlers = [debounce(this.resizeToPane, 10)];
  if (window.onresize) {
    resizeHandlers.push(window.onresize);
  }
  window.onresize = function (evt) {
    resizeHandlers.forEach(function (handler) {
      handler(evt);
    });
  };
};

TermView.prototype.detachResizeEvents = function () {
  window.onresize = this.resizeHandlers.pop();
  this.off("focus", this.resizeToPane);
  this.resizeHandlers = [];
  clearInterval(this.resizeInterval);
};

TermView.prototype.resizeToPane = function () {
  var dims = this.getDimensions();
  if (this.term.rows === dims.rows && this.term.cols === dims.cols) return; // no change
  this.pty.resize(dims.cols, dims.rows);
  this.term.resize(dims.cols, dims.rows);
};

TermView.prototype.getDimensions = function () {
  var term = this.term;
  var colSize = term ? this.find(".terminal").width() / term.cols : 7; // default is 7
  var rowSize = term ? this.find(".terminal").height() / term.rows : 15; // default is 15
  var cols = this.width() / colSize | 0;
  var rows = this.height() / rowSize | 0;

  return {
    cols: cols,
    rows: rows
  };
};

TermView.prototype.destroy = function () {
  // this.eventElement.trigger('remove');
  this.detachResizeEvents();
  this.pty.destroy();
  this.term.destroy();
  // atom bug: closes all panes
  // atom.workspace.getActivePane().destroyActiveItem();
  var parentPane = atom.workspace.getActivePane();
  if (parentPane.activeItem === this) {
    parentPane.removeItem(parentPane.activeItem);
  }
  this.detach();
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2lyYWFzdGEvLmF0b20vcGFja2FnZXMvdGVybS9saWIvVGVybVZpZXcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlCLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNsQyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQztBQUNoQyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7QUFDdkMsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDOztBQUV2QixJQUFJLFNBQVMsR0FBRyxDQUFBLEdBQUUsQ0FBQyxjQUFjLENBQUM7QUFDbEMsSUFBSSxTQUFTLEdBQUcsbUJBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRTtBQUFFLE9BQUssSUFBSSxHQUFHLElBQUksTUFBTSxFQUFFO0FBQUUsUUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQUUsQUFBQyxTQUFTLElBQUksR0FBRztBQUFFLFFBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0dBQUUsQUFBQyxJQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQUFBQyxLQUFLLENBQUMsU0FB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QzlDO0FBQ0QsTUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0NBQ2YsQ0FBQyIsImZpbGUiOiIvaG9tZS9pcmFhc3RhLy5hdG9tL3BhY2thZ2VzL3Rlcm0vbGliL1Rlcm1WaWV3LmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHB0eWpzID0gcmVxdWlyZSgncHR5LmpzJyk7XG52YXIgVGVybWluYWwgPSByZXF1aXJlKCd0ZXJtLmpzJyk7XG52YXIgZGVib3VuY2UgPSByZXF1aXJlKCdkZWJvdW5jZScpO1xudmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG52YXIgJCA9IHJlcXVpcmUoJ2F0b20nKS4kO1xudmFyIFZpZXcgPSByZXF1aXJlKCdhdG9tJykuVmlldztcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGtleXBhdGhlciA9IHJlcXVpcmUoJ2tleXBhdGhlcicpKCk7XG52YXIgb3MgPSByZXF1aXJlKCdvcycpO1xuLy8gdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbnZhciBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eTtcbnZhciBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcbnZhciBsYXN0ID0gZnVuY3Rpb24gKHN0cikge1xuICByZXR1cm4gc3RyW3N0ci5sZW5ndGgtMV07XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRlcm1WaWV3O1xuXG5mdW5jdGlvbiBUZXJtVmlldyAob3B0cykge1xuICBvcHRzID0gb3B0cyB8fCB7fTtcbiAgdGhpcy5vcHRzID0gb3B0cztcbiAgb3B0cy5zaGVsbCA9IHByb2Nlc3MuZW52LlNIRUxMIHx8ICdiYXNoJztcbiAgdmFyIGVkaXRvclBhdGggPSBrZXlwYXRoZXIuZ2V0KGF0b20sICd3b3Jrc3BhY2UuZ2V0RWRpdG9yVmlld3NbMF0uZ2V0RWRpdG9yKCkuZ2V0UGF0aCgpJyk7XG4gIG9wdHMuY3dkID0gb3B0cy5jd2QgfHwgYXRvbS5wcm9qZWN0LmdldFBhdGgoKSB8fFxuICAgIGVkaXRvclBhdGggfHwgcHJvY2Vzcy5lbnYuSE9NRSB8fFxuICAgIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICcuLicpOyAvLyBiYWNrIG91dCBvZiAuYXRvbS9wYWNrYWdlcy90ZXJtL2xpYlxuICBUZXJtVmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cblxuLy8gdXRpbC5pbmhlcml0cyhUZXJtVmlldywgRXZlbnRFbWl0dGVyKTtcbl9fZXh0ZW5kcyhUZXJtVmlldywgVmlldyk7XG5cblRlcm1WaWV3LmNvbnRlbnQgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB0aGlzLmRpdih7IGNsYXNzOiAndGVybScgfSk7XG59O1xuXG5UZXJtVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gIHZhciBvcHRzID0gdGhpcy5vcHRzO1xuICB2YXIgZGltcyA9IHRoaXMuZ2V0RGltZW5zaW9ucygpO1xuICB2YXIgcHR5ID0gdGhpcy5wdHkgPSBwdHlqcy5zcGF3bihvcHRzLnNoZWxsLCBbXSwge1xuICAgIG5hbWU6ICd4dGVybS1jb2xvcicsXG4gICAgY29sczogZGltcy5jb2xzLFxuICAgIHJvd3M6IGRpbXMucm93cyxcbiAgICBjd2Q6IG9wdHMuY3dkLFxuICAgIGVudjogcHJvY2Vzcy5lbnZcbiAgfSk7XG4gIHZhciB0ZXJtID0gdGhpcy50ZXJtID0gbmV3IFRlcm1pbmFsKHtcbiAgICBjb2xzOiBkaW1zLmNvbHMsXG4gICAgcm93czogZGltcy5yb3dzLFxuICAgIHVzZVN0eWxlOiB0cnVlLFxuICAgIHNjcmVlbktleXM6IHRydWUsXG4gIH0pO1xuICB0ZXJtLm9uKCdkYXRhJywgcHR5LndyaXRlLmJpbmQocHR5KSk7XG4gIHRlcm0ub3Blbih0aGlzWzBdKTtcbiAgaWYgKHRoaXMub3B0cy5ydW5Db21tYW5kKSB7XG4gICAgcHR5LndyaXRlKHRoaXMub3B0cy5ydW5Db21tYW5kICsgb3MuRU9MKTtcbiAgfVxuICBwdHkucGlwZSh0ZXJtKTtcbiAgdGVybS5lbmQgPSB0aGlzLmRlc3Ryb3kuYmluZCh0aGlzKTtcbiAgdGVybS5mb2N1cygpO1xuXG4gIHRoaXMuYXR0YWNoRXZlbnRzKCk7XG5cbiAgd2luZG93LnRlcm0gPSB0ZXJtO1xuICB3aW5kb3cucHR5ID0gcHR5O1xufTtcblxuVGVybVZpZXcucHJvdG90eXBlLmdldFRpdGxlID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gJygnICsgbGFzdCh0aGlzLm9wdHMuc2hlbGwuc3BsaXQoJy8nKSkgKyAnKSc7XG59O1xuXG5UZXJtVmlldy5wcm90b3R5cGUuYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLnJlc2l6ZVRvUGFuZSA9IHRoaXMucmVzaXplVG9QYW5lLmJpbmQodGhpcyk7XG4gIHRoaXMuYXR0YWNoUmVzaXplRXZlbnRzKCk7XG59O1xuXG5UZXJtVmlldy5wcm90b3R5cGUuYXR0YWNoUmVzaXplRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAvLyBjYWxsIGltbWVkaWF0ZWx5IChhZnRlciB0aW1lb3V0KSBmb3IgaW5pdGlhbCBzaXppbmdcbiAgdmFyIHNlbGYgPSB0aGlzO1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICBzZWxmLnJlc2l6ZVRvUGFuZS5iaW5kKHNlbGYpO1xuICB9LCAxMCk7XG5cbiAgLy8gZm9jdXNcbiAgdGhpcy5vbignZm9jdXMnLCB0aGlzLnJlc2l6ZVRvUGFuZSk7XG4gIHZhciBwYXJlbnRQYW5lID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZSgpO1xuICAvLyBhdG9tIG1pc3Npbmc6IG5vIGl0ZW0tYWN0aXZhdGVkIGV2ZW50IDotLywgdXNlIGludGVydmFsIGZvciBub3dcbiAgLy8gcGFyZW50UGFuZS5vbignaXRlbS1hY3RpdmF0ZWQnLCBmdW5jdGlvbiAoaXRlbSkge1xuICAvLyAgIGlmIChpdGVtID09PSBzZWxmKSBzZWxmLnJlc2l6ZVRvUGFuZSgpO1xuICAvLyB9KTtcbiAgdGhpcy5yZXNpemVJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMucmVzaXplVG9QYW5lLmJpbmQodGhpcyksIDUwKTtcbiAgLy8gcmVzaXplXG4gIHZhciByZXNpemVIYW5kbGVycyA9IHRoaXMucmVzaXplSGFuZGxlcnMgPSBbZGVib3VuY2UodGhpcy5yZXNpemVUb1BhbmUsIDEwKV07XG4gIGlmICh3aW5kb3cub25yZXNpemUpIHtcbiAgICByZXNpemVIYW5kbGVycy5wdXNoKHdpbmRvdy5vbnJlc2l6ZSk7XG4gIH1cbiAgd2luZG93Lm9ucmVzaXplID0gZnVuY3Rpb24gKGV2dCkge1xuICAgIHJlc2l6ZUhhbmRsZXJzLmZvckVhY2goZnVuY3Rpb24gKGhhbmRsZXIpIHtcbiAgICAgIGhhbmRsZXIoZXZ0KTtcbiAgICB9KTtcbiAgfTtcbn07XG5cblRlcm1WaWV3LnByb3RvdHlwZS5kZXRhY2hSZXNpemVFdmVudHMgPSBmdW5jdGlvbiAoKSB7XG4gIHdpbmRvdy5vbnJlc2l6ZSA9IHRoaXMucmVzaXplSGFuZGxlcnMucG9wKCk7XG4gIHRoaXMub2ZmKCdmb2N1cycsIHRoaXMucmVzaXplVG9QYW5lKTtcbiAgdGhpcy5yZXNpemVIYW5kbGVycyA9IFtdO1xuICBjbGVhckludGVydmFsKHRoaXMucmVzaXplSW50ZXJ2YWwpO1xufTtcblxuVGVybVZpZXcucHJvdG90eXBlLnJlc2l6ZVRvUGFuZSA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIGRpbXMgPSB0aGlzLmdldERpbWVuc2lvbnMoKTtcbiAgaWYgKHRoaXMudGVybS5yb3dzID09PSBkaW1zLnJvd3MgJiYgdGhpcy50ZXJtLmNvbHMgPT09IGRpbXMuY29scykgcmV0dXJuOyAvLyBubyBjaGFuZ2VcbiAgdGhpcy5wdHkucmVzaXplKGRpbXMuY29scywgZGltcy5yb3dzKTtcbiAgdGhpcy50ZXJtLnJlc2l6ZShkaW1zLmNvbHMsIGRpbXMucm93cyk7XG59O1xuXG5UZXJtVmlldy5wcm90b3R5cGUuZ2V0RGltZW5zaW9ucyA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHRlcm0gPSB0aGlzLnRlcm07XG4gIHZhciBjb2xTaXplID0gdGVybSA/IHRoaXMuZmluZCgnLnRlcm1pbmFsJykud2lkdGgoKSAvIHRlcm0uY29scyA6IDc7IC8vIGRlZmF1bHQgaXMgN1xuICB2YXIgcm93U2l6ZSA9IHRlcm0gPyB0aGlzLmZpbmQoJy50ZXJtaW5hbCcpLmhlaWdodCgpIC8gdGVybS5yb3dzIDogMTU7IC8vIGRlZmF1bHQgaXMgMTVcbiAgdmFyIGNvbHMgPSB0aGlzLndpZHRoKCkgIC8gY29sU2l6ZSB8IDA7XG4gIHZhciByb3dzID0gdGhpcy5oZWlnaHQoKSAvIHJvd1NpemUgfCAwO1xuXG4gIHJldHVybiB7XG4gICAgY29sczogY29scyxcbiAgICByb3dzOiByb3dzXG4gIH07XG59O1xuXG5UZXJtVmlldy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgLy8gdGhpcy5ldmVudEVsZW1lbnQudHJpZ2dlcigncmVtb3ZlJyk7XG4gIHRoaXMuZGV0YWNoUmVzaXplRXZlbnRzKCk7XG4gIHRoaXMucHR5LmRlc3Ryb3koKTtcbiAgdGhpcy50ZXJtLmRlc3Ryb3koKTtcbiAgLy8gYXRvbSBidWc6IGNsb3NlcyBhbGwgcGFuZXNcbiAgLy8gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZSgpLmRlc3Ryb3lBY3RpdmVJdGVtKCk7XG4gIHZhciBwYXJlbnRQYW5lID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZSgpO1xuICBpZiAocGFyZW50UGFuZS5hY3RpdmVJdGVtID09PSB0aGlzKSB7XG4gICAgcGFyZW50UGFuZS5yZW1vdmVJdGVtKHBhcmVudFBhbmUuYWN0aXZlSXRlbSk7XG4gIH1cbiAgdGhpcy5kZXRhY2goKTtcbn07XG4iXX0=