/**
 * pty.js
 * Copyright (c) 2012-2015, Christopher Jeffrey (MIT License)
 * Binding to the pseudo terminals.
 */

var extend = require("extend");
var pty = require("../build/Release/pty.node");
var net = require("net");
var tty = require("tty");

var version = process.versions.node.split(".").map(function (n) {
  return +(n + "").split("-")[0];
});

/**
 * Terminal
 */

// Example:
//  var term = new Terminal('bash', [], {
//    name: 'xterm-color',
//    cols: 80,
//    rows: 24,
//    cwd: process.env.HOME,
//    env: process.env
//  });

function Terminal(file, args, opt) {
  if (!(this instanceof Terminal)) {
    return new Terminal(file, args, opt);
  }

  var self = this,
      env,
      cwd,
      name,
      cols,
      rows,
      term;

  // backward compatibility
  if (typeof args === "string") {
    opt = {
      name: arguments[1],
      cols: arguments[2],
      rows: arguments[3],
      cwd: process.env.HOME
    };
    args = [];
  }

  // arguments
  args = args || [];
  file = file || "sh";
  opt = opt || {};

  cols = opt.cols || 80;
  rows = opt.rows || 24;

  opt.env = opt.env || process.env;
  env = extend({}, opt.env);

  if (opt.env === process.env) {
    // Make sure we didn't start our
    // server from inside tmux.
    delete env.TMUX;
    delete env.TMUX_PANE;

    // Make sure we didn't start
    // our server from inside screen.
    // http://web.mit.edu/gnu/doc/html/screen_20.html
    delete env.STY;
    delete env.WINDOW;

    // Delete some variables that
    // might confuse our terminal.
    delete env.WINDOWID;
    delete env.TERMCAP;
    delete env.COLUMNS;
    delete env.LINES;
  }

  // Could set some basic env vars
  // here, if they do not exist:
  // USER, SHELL, HOME, LOGNAME, WINDOWID

  cwd = opt.cwd || process.cwd();
  name = opt.name || env.TERM || "xterm";
  env.TERM = name;
  env.LINES = rows + "";
  env.COLUMNS = cols + "";

  env = environ(env);

  // fork
  term = opt.uid && opt.gid ? pty.fork(file, args, env, cwd, cols, rows, opt.uid, opt.gid) : pty.fork(file, args, env, cwd, cols, rows);

  this.socket = TTYStream(term.fd);
  this.socket.setEncoding("utf8");
  this.socket.resume();

  // setup
  this.socket.on("error", function (err) {
    // NOTE: fs.ReadStream gets EAGAIN twice at first:
    if (err.code) {
      if (~err.code.indexOf("EAGAIN")) return;
    }

    // close
    self._close();
    // EIO on exit from fs.ReadStream:
    if (!self._emittedExit) {
      self._emittedExit = true;
      Terminal.total--;
      self.emit("exit", null);
    }

    // EIO, happens when someone closes our child
    // process: the only process in the terminal.
    // node < 0.6.14: errno 5
    // node >= 0.6.14: read EIO
    if (err.code) {
      if (~err.code.indexOf("errno 5") || ~err.code.indexOf("EIO")) return;
    }

    // throw anything else
    if (self.listeners("error").length < 2) {
      throw err;
    }
  });

  this.pid = term.pid;
  this.fd = term.fd;
  this.pty = term.pty;

  this.file = file;
  this.name = name;
  this.cols = cols;
  this.rows = rows;

  this.readable = true;
  this.writable = true;

  Terminal.total++;
  // XXX This never gets emitted with v0.12.0
  this.socket.on("close", function () {
    if (self._emittedExit) return;
    self._emittedExit = true;
    Terminal.total--;
    self._close();
    self.emit("exit", null);
  });

  env = null;
}

Terminal.fork = Terminal.spawn = Terminal.createTerminal = function (file, args, opt) {
  return new Terminal(file, args, opt);
};

/**
 * openpty
 */

Terminal.open = function (opt) {
  var self = Object.create(Terminal.prototype),
      opt = opt || {};

  if (arguments.length > 1) {
    opt = {
      cols: arguments[1],
      rows: arguments[2]
    };
  }

  var cols = opt.cols || 80,
      rows = opt.rows || 24,
      term;

  // open
  term = pty.open(cols, rows);

  self.master = TTYStream(term.master);
  self.master.setEncoding("utf8");
  self.master.resume();

  self.slave = TTYStream(term.slave);
  self.slave.setEncoding("utf8");
  self.slave.resume();

  self.socket = self.master;
  self.pid = null;
  self.fd = term.master;
  self.pty = term.pty;

  self.file = process.argv[0] || "node";
  self.name = process.env.TERM || "";
  self.cols = cols;
  self.rows = rows;

  self.readable = true;
  self.writable = true;

  self.socket.on("error", function (err) {
    Terminal.total--;
    self._close();
    if (self.listeners("error").length < 2) {
      throw err;
    }
  });

  Terminal.total++;
  self.socket.on("close", function () {
    Terminal.total--;
    self._close();
  });

  return self;
};

/**
 * Total
 */

// Keep track of the total
// number of terminals for
// the process.
Terminal.total = 0;

/**
 * Events
 */

Terminal.prototype.write = function (data) {
  return this.socket.write(data);
};

Terminal.prototype.end = function (data) {
  return this.socket.end(data);
};

Terminal.prototype.pipe = function (dest, options) {
  return this.socket.pipe(dest, options);
};

Terminal.prototype.pause = function () {
  return this.socket.pause();
};

Terminal.prototype.resume = function () {
  return this.socket.resume();
};

Terminal.prototype.setEncoding = function (enc) {
  if (this.socket._decoder) {
    delete this.socket._decoder;
  }
  if (enc) {
    this.socket.setEncoding(enc);
  }
};

Terminal.prototype.addListener = Terminal.prototype.on = function (type, func) {
  this.socket.on(type, func);
  return this;
};

Terminal.prototype.emit = function () {
  return this.socket.emit.apply(this.socket, arguments);
};

Terminal.prototype.listeners = function (type) {
  return this.socket.listeners(type);
};

Terminal.prototype.removeListener = function (type, func) {
  this.socket.removeListener(type, func);
  return this;
};

Terminal.prototype.removeAllListeners = function (type) {
  this.socket.removeAllListeners(type);
  return this;
};

Terminal.prototype.once = function (type, func) {
  this.socket.once(type, func);
  return this;
};

Terminal.prototype.__defineGetter__("stdin", function () {
  return this;
});

Terminal.prototype.__defineGetter__("stdout", function () {
  return this;
});

Terminal.prototype.__defineGetter__("stderr", function () {
  throw new Error("No stderr.");
});

/**
 * TTY
 */

Terminal.prototype.resize = function (cols, rows) {
  cols = cols || 80;
  rows = rows || 24;

  this.cols = cols;
  this.rows = rows;

  pty.resize(this.fd, cols, rows);
};

Terminal.prototype.destroy = function () {
  var self = this;

  // close
  this._close();

  // Need to close the read stream so
  // node stops reading a dead file descriptor.
  // Then we can safely SIGHUP the shell.
  this.socket.once("close", function () {
    self.kill("SIGHUP");
  });

  this.socket.destroy();
};

Terminal.prototype.kill = function (sig) {
  try {
    process.kill(this.pid, sig || "SIGHUP");
  } catch (e) {
    ;
  }
};

Terminal.prototype.redraw = function () {
  var self = this,
      cols = this.cols,
      rows = this.rows;

  // We could just send SIGWINCH, but most programs will
  // ignore it if the size hasn't actually changed.

  this.resize(cols + 1, rows + 1);

  setTimeout(function () {
    self.resize(cols, rows);
  }, 30);
};

Terminal.prototype.__defineGetter__("process", function () {
  return pty.process(this.fd, this.pty) || this.file;
});

Terminal.prototype._close = function () {
  this.socket.writable = false;
  this.socket.readable = false;
  this.write = function () {};
  this.end = function () {};
  this.writable = false;
  this.readable = false;
};

/**
 * TTY Stream
 */

function TTYStream(fd) {
  // Could use: if (!require('tty').ReadStream)
  if (version[0] === 0 && version[1] < 7) {
    return new net.Socket(fd);
  }

  if (version[0] === 0 && version[1] < 12) {
    return new tty.ReadStream(fd);
  }

  return new Socket(fd);
}

/**
 * Wrap net.Socket for a workaround
 */

function Socket(options) {
  if (!(this instanceof Socket)) {
    return new Socket(options);
  }
  var tty = process.binding("tty_wrap");
  var guessHandleType = tty.guessHandleType;
  tty.guessHandleType = function () {
    return "PIPE";
  };
  net.Socket.call(this, options);
  tty.guessHandleType = guessHandleType;
}

Socket.prototype.__proto__ = net.Socket.prototype;

/**
 * Helpers
 */

function environ(env) {
  var keys = Object.keys(env || {}),
      l = keys.length,
      i = 0,
      pairs = [];

  for (; i < l; i++) {
    pairs.push(keys[i] + "=" + env[keys[i]]);
  }

  return pairs;
}

/**
 * Expose
 */

module.exports = exports = Terminal;
exports.Terminal = Terminal;
exports.native = pty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2lyYWFzdGEvLmF0b20vcGFja2FnZXMvYXV0b2NvbXBsZXRlLWVybGFuZy9saWIvc2VydmVyL3B0eS5qcy9saWIvcHR5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQU1BLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUMvQyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekIsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDOztBQUV6QixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVMsQ0FBQyxFQUFFO0FBQzdELFNBQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUEsQ0FBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDaEMsQ0FBQyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7QUFlSCxTQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtBQUNqQyxNQUFJLEVBQUUsSUFBSSxZQUFZLFFBQVEsQ0FBQSxBQUFDLEVBQUU7QUFDL0IsV0FBTyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0dBQ3RDOztBQUVELE1BQUksSUFBSSxHQUFHLElBQUk7TUFDWCxHQUFHO01BQ0gsR0FBRztNQUNILElBQUk7TUFDSixJQUFJO01BQ0osSUFBSTtNQUNKLElBQUksQ0FBQzs7O0FBR1QsTUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7QUFDNUIsT0FBRyxHQUFHO0FBQ0osVUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsVUFBSSxFQUFFLFNBQVMs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TUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDO01BQzdCLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTTtNQUNmLENBQUMsR0FBRyxDQUFDO01BQ0wsS0FBSyxHQUFHLEVBQUUsQ0FBQzs7QUFFZixTQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDakIsU0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0dBQzFDOztBQUVELFNBQU8sS0FBSyxDQUFDO0NBQ2Q7Ozs7OztBQU1ELE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxHQUFHLFFBQVEsQ0FBQztBQUNwQyxPQUFPLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztBQUM1QixPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyIsImZpbGUiOiIvaG9tZS9pcmFhc3RhLy5hdG9tL3BhY2thZ2VzL2F1dG9jb21wbGV0ZS1lcmxhbmcvbGliL3NlcnZlci9wdHkuanMvbGliL3B0eS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogcHR5LmpzXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTItMjAxNSwgQ2hyaXN0b3BoZXIgSmVmZnJleSAoTUlUIExpY2Vuc2UpXG4gKiBCaW5kaW5nIHRvIHRoZSBwc2V1ZG8gdGVybWluYWxzLlxuICovXG5cbnZhciBleHRlbmQgPSByZXF1aXJlKCdleHRlbmQnKTtcbnZhciBwdHkgPSByZXF1aXJlKCcuLi9idWlsZC9SZWxlYXNlL3B0eS5ub2RlJyk7XG52YXIgbmV0ID0gcmVxdWlyZSgnbmV0Jyk7XG52YXIgdHR5ID0gcmVxdWlyZSgndHR5Jyk7XG5cbnZhciB2ZXJzaW9uID0gcHJvY2Vzcy52ZXJzaW9ucy5ub2RlLnNwbGl0KCcuJykubWFwKGZ1bmN0aW9uKG4pIHtcbiAgcmV0dXJuICsobiArICcnKS5zcGxpdCgnLScpWzBdO1xufSk7XG5cbi8qKlxuICogVGVybWluYWxcbiAqL1xuXG4vLyBFeGFtcGxlOlxuLy8gIHZhciB0ZXJtID0gbmV3IFRlcm1pbmFsKCdiYXNoJywgW10sIHtcbi8vICAgIG5hbWU6ICd4dGVybS1jb2xvcicsXG4vLyAgICBjb2xzOiA4MCxcbi8vICAgIHJvd3M6IDI0LFxuLy8gICAgY3dkOiBwcm9jZXNzLmVudi5IT01FLFxuLy8gICAgZW52OiBwcm9jZXNzLmVudlxuLy8gIH0pO1xuXG5mdW5jdGlvbiBUZXJtaW5hbChmaWxlLCBhcmdzLCBvcHQpIHtcbiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRlcm1pbmFsKSkge1xuICAgIHJldHVybiBuZXcgVGVybWluYWwoZmlsZSwgYXJncywgb3B0KTtcbiAgfVxuXG4gIHZhciBzZWxmID0gdGhpc1xuICAgICwgZW52XG4gICAgLCBjd2RcbiAgICAsIG5hbWVcbiAgICAsIGNvbHNcbiAgICAsIHJvd3NcbiAgICAsIHRlcm07XG5cbiAgLy8gYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuICBpZiAodHlwZW9mIGFyZ3MgPT09ICdzdHJpbmcnKSB7XG4gICAgb3B0ID0ge1xuICAgICAgbmFtZTogYXJndW1lbnRzWzFdLFxuICAgICAgY29sczogYXJndW1lbnRzWzJdLFxuICAgICAgcm93czogYXJndW1lbnRzWzNdLFxuICAgICAgY3dkOiBwcm9jZXNzLmVudi5IT01FXG4gICAgfTtcbiAgICBhcmdzID0gW107XG4gIH1cblxuICAvLyBhcmd1bWVudHNcbiAgYXJncyA9IGFyZ3MgfHwgW107XG4gIGZpbGUgPSBmaWxlIHx8ICdzaCc7XG4gIG9wdCA9IG9wdCB8fCB7fTtcblxuICBjb2xzID0gb3B0LmNvbHMgfHwgODA7XG4gIHJvd3MgPSBvcHQucm93cyB8fCAyNDtcblxuICBvcHQuZW52ID0gb3B0LmVudiB8fCBwcm9jZXNzLmVudjtcbiAgZW52ID0gZXh0ZW5kKHt9LCBvcHQuZW52KTtcblxuICBpZiAob3B0LmVudiA9PT0gcHJvY2Vzcy5lbnYpIHtcbiAgICAvLyBNYWtlIHN1cmUgd2UgZGlkbid0IHN0YXJ0IG91clxuICAgIC8vIHNlcnZlciBmcm9tIGluc2lkZSB0bXV4LlxuICAgIGRlbGV0ZSBlbnYuVE1VWDtcbiAgICBkZWxldGUgZW52LlRNVVhfUEFORTtcblxuICAgIC8vIE1ha2Ugc3VyZSB3ZSBkaWRuJ3Qgc3RhcnRcbiAgICAvLyBvdXIgc2VydmVyIGZyb20gaW5zaWRlIHNjcmVlbi5cbiAgICAvLyBodHRwOi8vd2ViLm1pdC5lZHUvZ251L2RvYy9odG1sL3NjcmVlbl8yMC5odG1sXG4gICAgZGVsZXRlIGVudi5TVFk7XG4gICAgZGVsZXRlIGVudi5XSU5ET1c7XG5cbiAgICAvLyBEZWxldGUgc29tZSB2YXJpYWJsZXMgdGhhdFxuICAgIC8vIG1pZ2h0IGNvbmZ1c2Ugb3VyIHRlcm1pbmFsLlxuICAgIGRlbGV0ZSBlbnYuV0lORE9XSUQ7XG4gICAgZGVsZXRlIGVudi5URVJNQ0FQO1xuICAgIGRlbGV0ZSBlbnYuQ09MVU1OUztcbiAgICBkZWxldGUgZW52LkxJTkVTO1xuICB9XG5cbiAgLy8gQ291bGQgc2V0IHNvbWUgYmFzaWMgZW52IHZhcnNcbiAgLy8gaGVyZSwgaWYgdGhleSBkbyBub3QgZXhpc3Q6XG4gIC8vIFVTRVIsIFNIRUxMLCBIT01FLCBMT0dOQU1FLCBXSU5ET1dJRFxuXG4gIGN3ZCA9IG9wdC5jd2QgfHwgcHJvY2Vzcy5jd2QoKTtcbiAgbmFtZSA9IG9wdC5uYW1lIHx8IGVudi5URVJNIHx8ICd4dGVybSc7XG4gIGVudi5URVJNID0gbmFtZTtcbiAgZW52LkxJTkVTID0gcm93cyArICcnO1xuICBlbnYuQ09MVU1OUyA9IGNvbHMgKyAnJztcblxuICBlbnYgPSBlbnZpcm9uKGVudik7XG5cbiAgLy8gZm9ya1xuICB0ZXJtID0gb3B0LnVpZCAmJiBvcHQuZ2lkXG4gICAgPyBwdHkuZm9yayhmaWxlLCBhcmdzLCBlbnYsIGN3ZCwgY29scywgcm93cywgb3B0LnVpZCwgb3B0LmdpZClcbiAgICA6IHB0eS5mb3JrKGZpbGUsIGFyZ3MsIGVudiwgY3dkLCBjb2xzLCByb3dzKTtcblxuICB0aGlzLnNvY2tldCA9IFRUWVN0cmVhbSh0ZXJtLmZkKTtcbiAgdGhpcy5zb2NrZXQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgdGhpcy5zb2NrZXQucmVzdW1lKCk7XG5cbiAgLy8gc2V0dXBcbiAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgLy8gTk9URTogZnMuUmVhZFN0cmVhbSBnZXRzIEVBR0FJTiB0d2ljZSBhdCBmaXJzdDpcbiAgICBpZiAoZXJyLmNvZGUpIHtcbiAgICAgIGlmICh+ZXJyLmNvZGUuaW5kZXhPZignRUFHQUlOJykpIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBjbG9zZVxuICAgIHNlbGYuX2Nsb3NlKCk7XG4gICAgLy8gRUlPIG9uIGV4aXQgZnJvbSBmcy5SZWFkU3RyZWFtOlxuICAgIGlmICghc2VsZi5fZW1pdHRlZEV4aXQpIHtcbiAgICAgIHNlbGYuX2VtaXR0ZWRFeGl0ID0gdHJ1ZTtcbiAgICAgIFRlcm1pbmFsLnRvdGFsLS07XG4gICAgICBzZWxmLmVtaXQoJ2V4aXQnLCBudWxsKTtcbiAgICB9XG5cbiAgICAvLyBFSU8sIGhhcHBlbnMgd2hlbiBzb21lb25lIGNsb3NlcyBvdXIgY2hpbGRcbiAgICAvLyBwcm9jZXNzOiB0aGUgb25seSBwcm9jZXNzIGluIHRoZSB0ZXJtaW5hbC5cbiAgICAvLyBub2RlIDwgMC42LjE0OiBlcnJubyA1XG4gICAgLy8gbm9kZSA+PSAwLjYuMTQ6IHJlYWQgRUlPXG4gICAgaWYgKGVyci5jb2RlKSB7XG4gICAgICBpZiAofmVyci5jb2RlLmluZGV4T2YoJ2Vycm5vIDUnKVxuICAgICAgICAgIHx8IH5lcnIuY29kZS5pbmRleE9mKCdFSU8nKSkgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHRocm93IGFueXRoaW5nIGVsc2VcbiAgICBpZiAoc2VsZi5saXN0ZW5lcnMoJ2Vycm9yJykubGVuZ3RoIDwgMikge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSk7XG5cbiAgdGhpcy5waWQgPSB0ZXJtLnBpZDtcbiAgdGhpcy5mZCA9IHRlcm0uZmQ7XG4gIHRoaXMucHR5ID0gdGVybS5wdHk7XG5cbiAgdGhpcy5maWxlID0gZmlsZTtcbiAgdGhpcy5uYW1lID0gbmFtZTtcbiAgdGhpcy5jb2xzID0gY29scztcbiAgdGhpcy5yb3dzID0gcm93cztcblxuICB0aGlzLnJlYWRhYmxlID0gdHJ1ZTtcbiAgdGhpcy53cml0YWJsZSA9IHRydWU7XG5cbiAgVGVybWluYWwudG90YWwrKztcbiAgLy8gWFhYIFRoaXMgbmV2ZXIgZ2V0cyBlbWl0dGVkIHdpdGggdjAuMTIuMFxuICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCBmdW5jdGlvbigpIHtcbiAgICBpZiAoc2VsZi5fZW1pdHRlZEV4aXQpIHJldHVybjtcbiAgICBzZWxmLl9lbWl0dGVkRXhpdCA9IHRydWU7XG4gICAgVGVybWluYWwudG90YWwtLTtcbiAgICBzZWxmLl9jbG9zZSgpO1xuICAgIHNlbGYuZW1pdCgnZXhpdCcsIG51bGwpO1xuICB9KTtcblxuICBlbnYgPSBudWxsO1xufVxuXG5UZXJtaW5hbC5mb3JrID1cblRlcm1pbmFsLnNwYXduID1cblRlcm1pbmFsLmNyZWF0ZVRlcm1pbmFsID0gZnVuY3Rpb24oZmlsZSwgYXJncywgb3B0KSB7XG4gIHJldHVybiBuZXcgVGVybWluYWwoZmlsZSwgYXJncywgb3B0KTtcbn07XG5cbi8qKlxuICogb3BlbnB0eVxuICovXG5cblRlcm1pbmFsLm9wZW4gPSBmdW5jdGlvbihvcHQpIHtcbiAgdmFyIHNlbGYgPSBPYmplY3QuY3JlYXRlKFRlcm1pbmFsLnByb3RvdHlwZSlcbiAgICAsIG9wdCA9IG9wdCB8fCB7fTtcblxuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHtcbiAgICBvcHQgPSB7XG4gICAgICBjb2xzOiBhcmd1bWVudHNbMV0sXG4gICAgICByb3dzOiBhcmd1bWVudHNbMl1cbiAgICB9O1xuICB9XG5cbiAgdmFyIGNvbHMgPSBvcHQuY29scyB8fCA4MFxuICAgICwgcm93cyA9IG9wdC5yb3dzIHx8IDI0XG4gICAgLCB0ZXJtO1xuXG4gIC8vIG9wZW5cbiAgdGVybSA9IHB0eS5vcGVuKGNvbHMsIHJvd3MpO1xuXG4gIHNlbGYubWFzdGVyID0gVFRZU3RyZWFtKHRlcm0ubWFzdGVyKTtcbiAgc2VsZi5tYXN0ZXIuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgc2VsZi5tYXN0ZXIucmVzdW1lKCk7XG5cbiAgc2VsZi5zbGF2ZSA9IFRUWVN0cmVhbSh0ZXJtLnNsYXZlKTtcbiAgc2VsZi5zbGF2ZS5zZXRFbmNvZGluZygndXRmOCcpO1xuICBzZWxmLnNsYXZlLnJlc3VtZSgpO1xuXG4gIHNlbGYuc29ja2V0ID0gc2VsZi5tYXN0ZXI7XG4gIHNlbGYucGlkID0gbnVsbDtcbiAgc2VsZi5mZCA9IHRlcm0ubWFzdGVyO1xuICBzZWxmLnB0eSA9IHRlcm0ucHR5O1xuXG4gIHNlbGYuZmlsZSA9IHByb2Nlc3MuYXJndlswXSB8fCAnbm9kZSc7XG4gIHNlbGYubmFtZSA9IHByb2Nlc3MuZW52LlRFUk0gfHwgJyc7XG4gIHNlbGYuY29scyA9IGNvbHM7XG4gIHNlbGYucm93cyA9IHJvd3M7XG5cbiAgc2VsZi5yZWFkYWJsZSA9IHRydWU7XG4gIHNlbGYud3JpdGFibGUgPSB0cnVlO1xuXG4gIHNlbGYuc29ja2V0Lm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikge1xuICAgIFRlcm1pbmFsLnRvdGFsLS07XG4gICAgc2VsZi5fY2xvc2UoKTtcbiAgICBpZiAoc2VsZi5saXN0ZW5lcnMoJ2Vycm9yJykubGVuZ3RoIDwgMikge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSk7XG5cbiAgVGVybWluYWwudG90YWwrKztcbiAgc2VsZi5zb2NrZXQub24oJ2Nsb3NlJywgZnVuY3Rpb24oKSB7XG4gICAgVGVybWluYWwudG90YWwtLTtcbiAgICBzZWxmLl9jbG9zZSgpO1xuICB9KTtcblxuICByZXR1cm4gc2VsZjtcbn07XG5cbi8qKlxuICogVG90YWxcbiAqL1xuXG4vLyBLZWVwIHRyYWNrIG9mIHRoZSB0b3RhbFxuLy8gbnVtYmVyIG9mIHRlcm1pbmFscyBmb3Jcbi8vIHRoZSBwcm9jZXNzLlxuVGVybWluYWwudG90YWwgPSAwO1xuXG4vKipcbiAqIEV2ZW50c1xuICovXG5cblRlcm1pbmFsLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgcmV0dXJuIHRoaXMuc29ja2V0LndyaXRlKGRhdGEpO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgcmV0dXJuIHRoaXMuc29ja2V0LmVuZChkYXRhKTtcbn07XG5cblRlcm1pbmFsLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oZGVzdCwgb3B0aW9ucykge1xuICByZXR1cm4gdGhpcy5zb2NrZXQucGlwZShkZXN0LCBvcHRpb25zKTtcbn07XG5cblRlcm1pbmFsLnByb3RvdHlwZS5wYXVzZSA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5zb2NrZXQucGF1c2UoKTtcbn07XG5cblRlcm1pbmFsLnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuc29ja2V0LnJlc3VtZSgpO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLnNldEVuY29kaW5nID0gZnVuY3Rpb24oZW5jKSB7XG4gIGlmICh0aGlzLnNvY2tldC5fZGVjb2Rlcikge1xuICAgIGRlbGV0ZSB0aGlzLnNvY2tldC5fZGVjb2RlcjtcbiAgfVxuICBpZiAoZW5jKSB7XG4gICAgdGhpcy5zb2NrZXQuc2V0RW5jb2RpbmcoZW5jKTtcbiAgfVxufTtcblxuVGVybWluYWwucHJvdG90eXBlLmFkZExpc3RlbmVyID1cblRlcm1pbmFsLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHtcbiAgdGhpcy5zb2NrZXQub24odHlwZSwgZnVuYyk7XG4gIHJldHVybiB0aGlzO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuc29ja2V0LmVtaXQuYXBwbHkodGhpcy5zb2NrZXQsIGFyZ3VtZW50cyk7XG59O1xuXG5UZXJtaW5hbC5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkge1xuICByZXR1cm4gdGhpcy5zb2NrZXQubGlzdGVuZXJzKHR5cGUpO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgZnVuYykge1xuICB0aGlzLnNvY2tldC5yZW1vdmVMaXN0ZW5lcih0eXBlLCBmdW5jKTtcbiAgcmV0dXJuIHRoaXM7XG59O1xuXG5UZXJtaW5hbC5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkge1xuICB0aGlzLnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnModHlwZSk7XG4gIHJldHVybiB0aGlzO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBmdW5jKSB7XG4gIHRoaXMuc29ja2V0Lm9uY2UodHlwZSwgZnVuYyk7XG4gIHJldHVybiB0aGlzO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLl9fZGVmaW5lR2V0dGVyX18oJ3N0ZGluJywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiB0aGlzO1xufSk7XG5cblRlcm1pbmFsLnByb3RvdHlwZS5fX2RlZmluZUdldHRlcl9fKCdzdGRvdXQnLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXM7XG59KTtcblxuVGVybWluYWwucHJvdG90eXBlLl9fZGVmaW5lR2V0dGVyX18oJ3N0ZGVycicsIGZ1bmN0aW9uKCkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ05vIHN0ZGVyci4nKTtcbn0pO1xuXG4vKipcbiAqIFRUWVxuICovXG5cblRlcm1pbmFsLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbihjb2xzLCByb3dzKSB7XG4gIGNvbHMgPSBjb2xzIHx8IDgwO1xuICByb3dzID0gcm93cyB8fCAyNDtcblxuICB0aGlzLmNvbHMgPSBjb2xzO1xuICB0aGlzLnJvd3MgPSByb3dzO1xuXG4gIHB0eS5yZXNpemUodGhpcy5mZCwgY29scywgcm93cyk7XG59O1xuXG5UZXJtaW5hbC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgLy8gY2xvc2VcbiAgdGhpcy5fY2xvc2UoKTtcblxuICAvLyBOZWVkIHRvIGNsb3NlIHRoZSByZWFkIHN0cmVhbSBzb1xuICAvLyBub2RlIHN0b3BzIHJlYWRpbmcgYSBkZWFkIGZpbGUgZGVzY3JpcHRvci5cbiAgLy8gVGhlbiB3ZSBjYW4gc2FmZWx5IFNJR0hVUCB0aGUgc2hlbGwuXG4gIHRoaXMuc29ja2V0Lm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24oKSB7XG4gICAgc2VsZi5raWxsKCdTSUdIVVAnKTtcbiAgfSk7XG5cbiAgdGhpcy5zb2NrZXQuZGVzdHJveSgpO1xufTtcblxuVGVybWluYWwucHJvdG90eXBlLmtpbGwgPSBmdW5jdGlvbihzaWcpIHtcbiAgdHJ5IHtcbiAgICBwcm9jZXNzLmtpbGwodGhpcy5waWQsIHNpZyB8fCAnU0lHSFVQJyk7XG4gIH0gY2F0Y2goZSkge1xuICAgIDtcbiAgfVxufTtcblxuVGVybWluYWwucHJvdG90eXBlLnJlZHJhdyA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXNcbiAgICAsIGNvbHMgPSB0aGlzLmNvbHNcbiAgICAsIHJvd3MgPSB0aGlzLnJvd3M7XG5cbiAgLy8gV2UgY291bGQganVzdCBzZW5kIFNJR1dJTkNILCBidXQgbW9zdCBwcm9ncmFtcyB3aWxsXG4gIC8vIGlnbm9yZSBpdCBpZiB0aGUgc2l6ZSBoYXNuJ3QgYWN0dWFsbHkgY2hhbmdlZC5cblxuICB0aGlzLnJlc2l6ZShjb2xzICsgMSwgcm93cyArIDEpO1xuXG4gIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgc2VsZi5yZXNpemUoY29scywgcm93cyk7XG4gIH0sIDMwKTtcbn07XG5cblRlcm1pbmFsLnByb3RvdHlwZS5fX2RlZmluZUdldHRlcl9fKCdwcm9jZXNzJywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiBwdHkucHJvY2Vzcyh0aGlzLmZkLCB0aGlzLnB0eSkgfHwgdGhpcy5maWxlO1xufSk7XG5cblRlcm1pbmFsLnByb3RvdHlwZS5fY2xvc2UgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5zb2NrZXQud3JpdGFibGUgPSBmYWxzZTtcbiAgdGhpcy5zb2NrZXQucmVhZGFibGUgPSBmYWxzZTtcbiAgdGhpcy53cml0ZSA9IGZ1bmN0aW9uKCkge307XG4gIHRoaXMuZW5kID0gZnVuY3Rpb24oKSB7fTtcbiAgdGhpcy53cml0YWJsZSA9IGZhbHNlO1xuICB0aGlzLnJlYWRhYmxlID0gZmFsc2U7XG59O1xuXG4vKipcbiAqIFRUWSBTdHJlYW1cbiAqL1xuXG5mdW5jdGlvbiBUVFlTdHJlYW0oZmQpIHtcbiAgLy8gQ291bGQgdXNlOiBpZiAoIXJlcXVpcmUoJ3R0eScpLlJlYWRTdHJlYW0pXG4gIGlmICh2ZXJzaW9uWzBdID09PSAwICYmIHZlcnNpb25bMV0gPCA3KSB7XG4gICAgcmV0dXJuIG5ldyBuZXQuU29ja2V0KGZkKTtcbiAgfVxuXG4gIGlmICh2ZXJzaW9uWzBdID09PSAwICYmIHZlcnNpb25bMV0gPCAxMikge1xuICAgIHJldHVybiBuZXcgdHR5LlJlYWRTdHJlYW0oZmQpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBTb2NrZXQoZmQpO1xufVxuXG4vKipcbiAqIFdyYXAgbmV0LlNvY2tldCBmb3IgYSB3b3JrYXJvdW5kXG4gKi9cblxuZnVuY3Rpb24gU29ja2V0KG9wdGlvbnMpIHtcbiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFNvY2tldCkpIHtcbiAgICByZXR1cm4gbmV3IFNvY2tldChvcHRpb25zKTtcbiAgfVxuICB2YXIgdHR5ID0gcHJvY2Vzcy5iaW5kaW5nKCd0dHlfd3JhcCcpO1xuICB2YXIgZ3Vlc3NIYW5kbGVUeXBlID0gdHR5Lmd1ZXNzSGFuZGxlVHlwZTtcbiAgdHR5Lmd1ZXNzSGFuZGxlVHlwZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAnUElQRSc7XG4gIH07XG4gIG5ldC5Tb2NrZXQuY2FsbCh0aGlzLCBvcHRpb25zKTtcbiAgdHR5Lmd1ZXNzSGFuZGxlVHlwZSA9IGd1ZXNzSGFuZGxlVHlwZTtcbn1cblxuU29ja2V0LnByb3RvdHlwZS5fX3Byb3RvX18gPSBuZXQuU29ja2V0LnByb3RvdHlwZTtcblxuLyoqXG4gKiBIZWxwZXJzXG4gKi9cblxuZnVuY3Rpb24gZW52aXJvbihlbnYpIHtcbiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhlbnYgfHwge30pXG4gICAgLCBsID0ga2V5cy5sZW5ndGhcbiAgICAsIGkgPSAwXG4gICAgLCBwYWlycyA9IFtdO1xuXG4gIGZvciAoOyBpIDwgbDsgaSsrKSB7XG4gICAgcGFpcnMucHVzaChrZXlzW2ldICsgJz0nICsgZW52W2tleXNbaV1dKTtcbiAgfVxuXG4gIHJldHVybiBwYWlycztcbn1cblxuLyoqXG4gKiBFeHBvc2VcbiAqL1xuXG5tb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBUZXJtaW5hbDtcbmV4cG9ydHMuVGVybWluYWwgPSBUZXJtaW5hbDtcbmV4cG9ydHMubmF0aXZlID0gcHR5O1xuIl19