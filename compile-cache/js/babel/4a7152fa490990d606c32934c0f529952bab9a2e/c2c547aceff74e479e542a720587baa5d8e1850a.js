
var RESULT_BUFFER_PERIOD = 100;

var server = require("../static");
var url = require("url");
var pty = require("../pty.js");
var helpers = require("./../helpers");
//var defRegExp = //helpers.$$$();

if (~process.argv.indexOf("--erlang-mode")) process.erlangMode = true;

/// INITIALIZATION
var erlCompServer = {};
var eliCompServer = {};
module.exports = erlCompServer;

server.on("/erl/complete", function (req, res) {
    var parameters = url.parse(req.url, true).query;
    erlCompServer.awaitCompletion(parameters.word, function (result) {
        res.end(JSON.stringify({ result: result }));
    });
});

server.on("/elixir/complete", function (req, res) {
    var parameters = url.parse(req.url, true).query;
    eliCompServer.awaitCompletion(parameters.word, function (result) {
        res.end(JSON.stringify({ result: result }));
    });
});

server.on("/erl/compile", function (req, res) {
    var parameters = url.parse(req.url, true).query;
    erlCompServer.compile(parameters.module.replace(/'/g, ""), function (result) {
        res.end(JSON.stringify(result, null, 2));
    });
});
server.on("/elixir/compile", function (req, res) {
    var parameters = url.parse(req.url, true).query;
    eliCompServer.compile(parameters.module.replace(/'/g, ""), function (result) {
        res.end(JSON.stringify(result, null, 2));
    });
});

server.on("/erl/dialyze", function (req, res) {
    var parameters = url.parse(req.url, true).query;
    erlCompServer.dialyze(parameters.module, function (result) {
        res.end(JSON.stringify(result, null, 2));
    });
});

server.on("/erl/definition", function (req, res, par) {
    var dirs = par.dirs.replace(/'/g, "").split(",");
    var name = par.name;
    var file = par.file || "";
    helpers.findDefinition(dirs, file + ".erl", new RegExp(name + "(.*) *->(.|\\n)*?\\.", "g"), function (result) {
        res.end(JSON.stringify(result));
    });
});

(function () {
    var term = pty.spawn("erl", [], {
        name: "xterm-color",
        cols: 80,
        rows: 30,
        cwd: process.env.HOME,
        env: process.env
    });
    term.on("error", function (e) {
        throw e;
    });

    erlCompServer.awaitCompletion = function (a, b, c) {
        awaitCompletion(a, b, c, term);
    };
    erlCompServer.compile = function (a, b) {
        compileModule(a, b, term);
    };
    erlCompServer.dialyze = dialyzeModule;
})();
(function () {
    var term = pty.spawn("iex", [], {
        name: "xterm-color",
        cols: 80,
        rows: 30,
        cwd: process.env.HOME,
        env: process.env
    });
    term.on("error", function (e) {
        throw e;
    });

    eliCompServer.awaitCompletion = function (a, b, c) {
        awaitCompletion(a, b, c, term, true);
    };
    eliCompServer.compile = function (a, b) {
        compileModule(a, b, term, true);
    };
    eliCompServer.dialyze = dialyzeModule;
})();

function awaitCompletion(word, callback, acc, term, isElixir) {
    acc = acc | "";
    word = word || "";

    term.write(word + "\t");
    var counter = 2;

    var bufferEE = helpers.bufferEE(term, "data", function (data) {
        data.split("\n").map(function (line) {
            acc += line + " ";
            if (word && new RegExp("^" + word.trim()).test(line.trim()) && !isList(line)) {
                counter--;
            } else if (word && new RegExp(word.trim() + "$").test(line.trim())) {
                counter--;
            }
            if (!counter) {
                bufferEE.flush();
            }
        });
    }, RESULT_BUFFER_PERIOD, function () {

        callback(prepareResult(acc, !!word && !!counter, isElixir));
        term.write((isElixir ? "" : ".") + "\n");
    });
}
function prepareResult(res, isOneLiner, isElixir) {

    try {
        var cake = res.match(/\S+/g);
        if (isElixir) {
            if (isOneLiner) {
                return [cake.join("").substr(1)];
            }
            return cake.slice(1, cake.length - 2);
        } else {

            if (isOneLiner) {
                // first result always looks weird "0application: "
                return /\D\S*/.exec(res);
            }
            return cake.slice(1, cake.length - 2).filter(function (a) {
                return a != "\u0007";
            });
        }
    } catch (e) {
        return [];
    }
}

function compileModule(name, cb, term, isElixir) {
    term.write("c(\"" + name + "\")" + (isElixir ? "\n" : ".\n"));
    var lines = [];
    var listenForData = (function (_listenForData) {
        var _listenForDataWrapper = function listenForData() {
            return _listenForData.apply(this, arguments);
        };

        _listenForDataWrapper.toString = function () {
            return _listenForData.toString();
        };

        return _listenForDataWrapper;
    })(function () {
        term.once("data", function (data) {
            var lastRes = false;
            data.split("\n").map(function (line) {
                var res = isElixir ? recognizeElixirLine(line) : recognizeCompilerLine(line);
                if (res) {
                    lines.push(res);
                    if (res.type == "result") {
                        cb(lines);
                        lastRes = true;
                    }
                }
            });
            if (!lastRes) {
                listenForData();
            }
        });
    });
    listenForData();
}
function recognizeCompilerLine(line) {
    //if tuple result
    if (!line.length) {
        return undefined;
    }line = line.trim();

    if (/^\{.*\}\s*$/.test(line) || /^\S*error*\S$/.test(line)) {
        return {
            type: "result",
            content: line
        };
    } else {
        var cake = line.split(":");
        return {
            type: / error /.test(line) ? "error" : "warning",
            path: cake[0],
            line: cake[1],
            content: cake.slice(2).join(":")
        };
    }
}
function recognizeElixirLine(line) {
    if (/\*\* \(/.test(line)) {
        var cake;
        var result = line.match(/\*\* \(SyntaxError\).*/);
        result = result ? result : line.match(/\*\* \(CompileError\).*/);
        if (result) {
            cake = result[0].replace(/\*\* \(SyntaxError\)/, "").split(":");
            return {
                type: "error",
                path: cake[0],
                line: cake[1],
                content: cake.slice(2).join(":")
            };
        }
        result = line.match(/\*\* \(exit\).*/);

        if (result) {
            return {
                type: "result"
            };
        }
    } else if (line.match(/\S*:.*:.*/)) {
        cake = line.split(":");
        return {
            type: "warning",
            path: cake[0],
            line: cake[1],
            content: cake.slice(2).join(":")
        };
    } else if (line.match(/iex\(/)) {
        return {
            type: "result"
        };
    } else {
        return undefined;
    }
}
function dialyzeModule(name, cb) {
    var dialTerm = pty.spawn("dialyzer", [name, "--quiet"], {
        name: "xterm-color",
        cols: 80,
        rows: 30,
        cwd: process.env.HOME,
        env: process.env
    });
    var lines = [];
    var awaitData = function awaitData() {
        dialTerm.on("data", function (data) {
            data.split("\n").map(function (line) {
                if (line) lines.push(recognizeDialyzerLine(line));
            });
        });
    };
    dialTerm.on("exit", function () {
        cb(lines);
    });
    dialTerm.on("error", function (e) {
        cb({ err: e });
    });

    awaitData();
}
function recognizeDialyzerLine(line) {
    var cake = line.split(":");
    return { path: cake[0], line: cake[1], content: cake.slice(2).join(":") };
}

function isList(w) {
    return /\S+\s+\S+/.test(w);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2lyYWFzdGEvLmF0b20vcGFja2FnZXMvYXV0b2NvbXBsZXRlLWVybGFuZy9saWIvc2VydmVyL2VybGFuZy9lcmxhbmcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLElBQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDOztBQUVqQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDbEMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3pCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7OztBQUd0QyxJQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUUsT0FBTyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7OztBQUdyRSxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7QUFDdkIsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDOztBQUUvQixNQUFNLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHLEVBQUM7QUFDekMsUUFBSSxVQUFVLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNoRCxpQkFBYSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEtBQVEsRUFBRSxVQUFTLE1BQU0sRUFBQztBQUM5RCxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBQyxNQUFNLEVBQUcsTUFBTSxFQUFDLENBQUMsQ0FBQyxDQUFBO0tBQzdDLENBQUMsQ0FBQztDQUNOLENBQUMsQ0FBQzs7QUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLGtCQUFrQixFQUFFLFVB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LEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUMsQ0FBQTtDQUMxRTs7QUFFRCxTQUFTLE1BQU0sQ0FBQyxDQUFDLEVBQUM7QUFDZCxXQUFPLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7Q0FDN0IiLCJmaWxlIjoiL2hvbWUvaXJhYXN0YS8uYXRvbS9wYWNrYWdlcy9hdXRvY29tcGxldGUtZXJsYW5nL2xpYi9zZXJ2ZXIvZXJsYW5nL2VybGFuZy5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuY29uc3QgUkVTVUxUX0JVRkZFUl9QRVJJT0QgPSAxMDA7XG5cbnZhciBzZXJ2ZXIgPSByZXF1aXJlKFwiLi4vc3RhdGljXCIpO1xudmFyIHVybCA9IHJlcXVpcmUoJ3VybCcpO1xudmFyIHB0eSA9IHJlcXVpcmUoJy4uL3B0eS5qcycpO1xudmFyIGhlbHBlcnMgPSByZXF1aXJlKFwiLi8uLi9oZWxwZXJzXCIpO1xuLy92YXIgZGVmUmVnRXhwID0gLy9oZWxwZXJzLiQkJCgpO1xuXG5pZih+cHJvY2Vzcy5hcmd2LmluZGV4T2YoXCItLWVybGFuZy1tb2RlXCIpKSBwcm9jZXNzLmVybGFuZ01vZGUgPSB0cnVlO1xuXG4vLy8gSU5JVElBTElaQVRJT05cbnZhciBlcmxDb21wU2VydmVyID0ge307XG52YXIgZWxpQ29tcFNlcnZlciA9IHt9O1xubW9kdWxlLmV4cG9ydHMgPSBlcmxDb21wU2VydmVyO1xuXG5zZXJ2ZXIub24oXCIvZXJsL2NvbXBsZXRlXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKXtcbiAgICB2YXIgcGFyYW1ldGVycyA9IHVybC5wYXJzZShyZXEudXJsLCB0cnVlKS5xdWVyeTtcbiAgICBlcmxDb21wU2VydmVyLmF3YWl0Q29tcGxldGlvbihwYXJhbWV0ZXJzW1wid29yZFwiXSwgZnVuY3Rpb24ocmVzdWx0KXtcbiAgICAgICAgcmVzLmVuZChKU09OLnN0cmluZ2lmeSh7cmVzdWx0IDogcmVzdWx0fSkpXG4gICAgfSk7XG59KTtcblxuc2VydmVyLm9uKFwiL2VsaXhpci9jb21wbGV0ZVwiLCBmdW5jdGlvbihyZXEsIHJlcyl7XG4gICAgdmFyIHBhcmFtZXRlcnMgPSB1cmwucGFyc2UocmVxLnVybCwgdHJ1ZSkucXVlcnk7XG4gICAgZWxpQ29tcFNlcnZlci5hd2FpdENvbXBsZXRpb24ocGFyYW1ldGVyc1tcIndvcmRcIl0sIGZ1bmN0aW9uKHJlc3VsdCl7XG4gICAgICAgIHJlcy5lbmQoSlNPTi5zdHJpbmdpZnkoe3Jlc3VsdCA6IHJlc3VsdH0pKVxuICAgIH0pO1xufSlcblxuc2VydmVyLm9uKFwiL2VybC9jb21waWxlXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKXtcbiAgICB2YXIgcGFyYW1ldGVycyA9IHVybC5wYXJzZShyZXEudXJsLCB0cnVlKS5xdWVyeTtcbiAgICBlcmxDb21wU2VydmVyLmNvbXBpbGUocGFyYW1ldGVyc1tcIm1vZHVsZVwiXS5yZXBsYWNlKC8nL2csXCJcIiksIGZ1bmN0aW9uKHJlc3VsdCl7XG4gICAgICAgIHJlcy5lbmQoSlNPTi5zdHJpbmdpZnkocmVzdWx0LCBudWxsLCAyKSlcbiAgICB9KVxufSk7XG5zZXJ2ZXIub24oXCIvZWxpeGlyL2NvbXBpbGVcIiwgZnVuY3Rpb24ocmVxLCByZXMpe1xuICAgIHZhciBwYXJhbWV0ZXJzID0gdXJsLnBhcnNlKHJlcS51cmwsIHRydWUpLnF1ZXJ5O1xuICAgIGVsaUNvbXBTZXJ2ZXIuY29tcGlsZShwYXJhbWV0ZXJzW1wibW9kdWxlXCJdLnJlcGxhY2UoLycvZyxcIlwiKSwgZnVuY3Rpb24ocmVzdWx0KXtcbiAgICAgICAgcmVzLmVuZChKU09OLnN0cmluZ2lmeShyZXN1bHQsIG51bGwsIDIpKVxuICAgIH0pXG59KTtcblxuXG5zZXJ2ZXIub24oXCIvZXJsL2RpYWx5emVcIiwgZnVuY3Rpb24ocmVxLCByZXMpe1xuICAgIHZhciBwYXJhbWV0ZXJzID0gdXJsLnBhcnNlKHJlcS51cmwsIHRydWUpLnF1ZXJ5O1xuICAgIGVybENvbXBTZXJ2ZXIuZGlhbHl6ZShwYXJhbWV0ZXJzW1wibW9kdWxlXCJdLCBmdW5jdGlvbihyZXN1bHQpe1xuICAgICAgICByZXMuZW5kKEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgMikpXG4gICAgfSlcbn0pO1xuXG5zZXJ2ZXIub24oXCIvZXJsL2RlZmluaXRpb25cIiwgZnVuY3Rpb24ocmVxLCByZXMsIHBhcil7XG4gICAgdmFyIGRpcnMgPSBwYXJbXCJkaXJzXCJdLnJlcGxhY2UoLycvZyxcIlwiKS5zcGxpdChcIixcIik7XG4gICAgdmFyIG5hbWUgPSBwYXJbXCJuYW1lXCJdO1xuICAgIHZhciBmaWxlID0gcGFyW1wiZmlsZVwiXSB8fCBcIlwiO1xuICAgIGhlbHBlcnMuZmluZERlZmluaXRpb24oZGlycywgZmlsZStcIi5lcmxcIiwgbmV3IFJlZ0V4cChuYW1lICtcIiguKikgKi0+KC58XFxcXG4pKj9cXFxcLlwiLCBcImdcIiksIGZ1bmN0aW9uKHJlc3VsdCl7XG4gICAgICAgIHJlcy5lbmQoSlNPTi5zdHJpbmdpZnkocmVzdWx0KSlcbiAgICB9KVxufSk7XG5cbihmdW5jdGlvbigpe1xuICAgIHZhciB0ZXJtID0gcHR5LnNwYXduKCdlcmwnLCBbXSwge1xuICAgICAgICBuYW1lOiAneHRlcm0tY29sb3InLFxuICAgICAgICBjb2xzOiA4MCxcbiAgICAgICAgcm93czogMzAsXG4gICAgICAgIGN3ZDogcHJvY2Vzcy5lbnYuSE9NRSxcbiAgICAgICAgZW52OiBwcm9jZXNzLmVudlxuICAgIH0pO1xuICAgIHRlcm0ub24oXCJlcnJvclwiLCBmdW5jdGlvbihlKXt0aHJvdyBlfSlcblxuICAgIGVybENvbXBTZXJ2ZXIuYXdhaXRDb21wbGV0aW9uID1mdW5jdGlvbihhLGIsYyl7IGF3YWl0Q29tcGxldGlvbihhLGIsYyx0ZXJtKX1cbiAgICBlcmxDb21wU2VydmVyLmNvbXBpbGUgPSBmdW5jdGlvbihhLGIpIHsgY29tcGlsZU1vZHVsZShhLGIsIHRlcm0pfTtcbiAgICBlcmxDb21wU2VydmVyLmRpYWx5emUgPSBkaWFseXplTW9kdWxlO1xufSkoKTtcbihmdW5jdGlvbigpe1xuICAgIHZhciB0ZXJtID0gcHR5LnNwYXduKCdpZXgnLCBbXSwge1xuICAgICAgICBuYW1lOiAneHRlcm0tY29sb3InLFxuICAgICAgICBjb2xzOiA4MCxcbiAgICAgICAgcm93czogMzAsXG4gICAgICAgIGN3ZDogcHJvY2Vzcy5lbnYuSE9NRSxcbiAgICAgICAgZW52OiBwcm9jZXNzLmVudlxuICAgIH0pO1xuICAgIHRlcm0ub24oXCJlcnJvclwiLCBmdW5jdGlvbihlKXt0aHJvdyBlfSlcblxuICAgIGVsaUNvbXBTZXJ2ZXIuYXdhaXRDb21wbGV0aW9uID1mdW5jdGlvbihhLGIsYyl7IGF3YWl0Q29tcGxldGlvbihhLGIsYyx0ZXJtLCB0cnVlKX1cbiAgICBlbGlDb21wU2VydmVyLmNvbXBpbGUgPSBmdW5jdGlvbihhLGIpIHsgY29tcGlsZU1vZHVsZShhLGIsIHRlcm0sIHRydWUpfTtcbiAgICBlbGlDb21wU2VydmVyLmRpYWx5emUgPSBkaWFseXplTW9kdWxlO1xufSkoKTtcblxuXG5mdW5jdGlvbiBhd2FpdENvbXBsZXRpb24od29yZCwgY2FsbGJhY2ssIGFjYywgdGVybSwgaXNFbGl4aXIpIHtcbiAgICBhY2MgPSBhY2MgfCBcIlwiO1xuICAgIHdvcmQgPSB3b3JkIHx8IFwiXCI7XG5cbiAgICB0ZXJtLndyaXRlKHdvcmQgKyBcIlxcdFwiKTtcbiAgICB2YXIgY291bnRlciA9IDI7XG5cbiAgICB2YXIgYnVmZmVyRUUgPSBoZWxwZXJzLmJ1ZmZlckVFKHRlcm0sIFwiZGF0YVwiLCBmdW5jdGlvbihkYXRhKXtcbiAgICAgICAgZGF0YS5zcGxpdChcIlxcblwiKS5tYXAoZnVuY3Rpb24obGluZSl7XG4gICAgICAgICAgICBhY2MgKz0gbGluZSArIFwiIFwiXG4gICAgICAgICAgICBpZih3b3JkICYmIChuZXcgUmVnRXhwKFwiXlwiK3dvcmQudHJpbSgpKSkudGVzdChsaW5lLnRyaW0oKSkgJiYgIWlzTGlzdChsaW5lKSl7XG4gICAgICAgICAgICAgICAgY291bnRlci0tXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmKHdvcmQgJiYgKG5ldyBSZWdFeHAod29yZC50cmltKCkrXCIkXCIpKS50ZXN0KGxpbmUudHJpbSgpKSl7XG4gICAgICAgICAgICAgICAgY291bnRlci0tXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZighY291bnRlcil7XG4gICAgICAgICAgICAgICAgYnVmZmVyRUUuZmx1c2goKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sIFJFU1VMVF9CVUZGRVJfUEVSSU9EICwgZnVuY3Rpb24oKXtcblxuICAgICAgICBjYWxsYmFjayhwcmVwYXJlUmVzdWx0KGFjYywgISF3b3JkICYmICEhY291bnRlciwgaXNFbGl4aXIpKTtcbiAgICAgICAgdGVybS53cml0ZSggKGlzRWxpeGlyID8gXCJcIiA6IFwiLlwiKSArIFwiXFxuXCIpXG4gICAgfSlcblxufVxuZnVuY3Rpb24gcHJlcGFyZVJlc3VsdChyZXMsIGlzT25lTGluZXIsIGlzRWxpeGlyKSB7XG5cbiAgICB0cnkge1xuICAgICAgICB2YXIgY2FrZSA9IHJlcy5tYXRjaCgvXFxTKy9nKTtcbiAgICAgICAgaWYgKGlzRWxpeGlyKSB7XG4gICAgICAgICAgICBpZiAoaXNPbmVMaW5lcikge1xuICAgICAgICAgICAgICAgIHJldHVybiBbY2FrZS5qb2luKFwiXCIpLnN1YnN0cigxKV1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjYWtlLnNsaWNlKDEsIGNha2UubGVuZ3RoIC0gMilcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgaWYgKGlzT25lTGluZXIpIHtcbiAgICAgICAgICAgICAgLy8gZmlyc3QgcmVzdWx0IGFsd2F5cyBsb29rcyB3ZWlyZCBcIjBhcHBsaWNhdGlvbjogXCJcbiAgICAgICAgICAgICAgICByZXR1cm4gL1xcRFxcUyovLmV4ZWMocmVzKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNha2Uuc2xpY2UoMSwgY2FrZS5sZW5ndGggLSAyKS5maWx0ZXIoZnVuY3Rpb24gKGEpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGEgIT0gXCJcXHUwMDA3XCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBbXVxuICAgIH1cbn1cblxuZnVuY3Rpb24gY29tcGlsZU1vZHVsZShuYW1lLCBjYiwgdGVybSwgaXNFbGl4aXIpe1xuICAgIHRlcm0ud3JpdGUoXCJjKFxcXCJcIiArIG5hbWUgKyBcIlxcXCIpXCIgKyAoaXNFbGl4aXIgPyBcIlxcblwiIDogXCIuXFxuXCIpKTtcbiAgICB2YXIgbGluZXMgPSBbXTtcbiAgICB2YXIgbGlzdGVuRm9yRGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB0ZXJtLm9uY2UoXCJkYXRhXCIsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICB2YXIgbGFzdFJlcyA9IGZhbHNlO1xuICAgICAgICAgICAgZGF0YS5zcGxpdChcIlxcblwiKS5tYXAoZnVuY3Rpb24gKGxpbmUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gaXNFbGl4aXIgPyByZWNvZ25pemVFbGl4aXJMaW5lKGxpbmUpIDogcmVjb2duaXplQ29tcGlsZXJMaW5lKGxpbmUpO1xuICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZXMucHVzaChyZXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnR5cGUgPT0gXCJyZXN1bHRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IobGluZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFJlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmKCFsYXN0UmVzKXtcbiAgICAgICAgICAgICAgICBsaXN0ZW5Gb3JEYXRhKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG4gICAgbGlzdGVuRm9yRGF0YSgpXG59XG5mdW5jdGlvbiByZWNvZ25pemVDb21waWxlckxpbmUobGluZSl7XG4gICAgLy9pZiB0dXBsZSByZXN1bHRcbiAgICBpZighbGluZS5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgbGluZSA9IGxpbmUudHJpbSgpO1xuXG4gICAgaWYoL15cXHsuKlxcfVxccyokLy50ZXN0KGxpbmUpIHx8IC9eXFxTKmVycm9yKlxcUyQvLnRlc3QobGluZSkpe1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogXCJyZXN1bHRcIixcbiAgICAgICAgICAgIGNvbnRlbnQ6IGxpbmVcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlXG4gICAge1xuICAgICAgICB2YXIgY2FrZSA9IGxpbmUuc3BsaXQoXCI6XCIpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogLyBlcnJvciAvLnRlc3QobGluZSkgPyBcImVycm9yXCIgOiBcIndhcm5pbmdcIiAsXG4gICAgICAgICAgICBwYXRoOiBjYWtlWzBdLFxuICAgICAgICAgICAgbGluZTogY2FrZVsxXSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGNha2Uuc2xpY2UoMikuam9pbihcIjpcIilcbiAgICAgICAgfVxuICAgIH1cbn1cbmZ1bmN0aW9uIHJlY29nbml6ZUVsaXhpckxpbmUobGluZSl7XG4gICAgaWYoL1xcKlxcKiBcXCgvLnRlc3QobGluZSkpe1xuICAgICAgICB2YXIgY2FrZTtcbiAgICAgICAgdmFyIHJlc3VsdCA9IGxpbmUubWF0Y2goL1xcKlxcKiBcXChTeW50YXhFcnJvclxcKS4qLylcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0ID8gcmVzdWx0IDogbGluZS5tYXRjaCgvXFwqXFwqIFxcKENvbXBpbGVFcnJvclxcKS4qLylcbiAgICAgICAgaWYocmVzdWx0KXtcbiAgICAgICAgICAgIGNha2UgPSByZXN1bHRbMF0ucmVwbGFjZSgvXFwqXFwqIFxcKFN5bnRheEVycm9yXFwpLywgXCJcIikuc3BsaXQoXCI6XCIpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcImVycm9yXCIsXG4gICAgICAgICAgICAgICAgcGF0aDogY2FrZVswXSxcbiAgICAgICAgICAgICAgICBsaW5lOiBjYWtlWzFdLFxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGNha2Uuc2xpY2UoMikuam9pbihcIjpcIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXN1bHQgPSBsaW5lLm1hdGNoKC9cXCpcXCogXFwoZXhpdFxcKS4qLylcblxuICAgICAgICBpZihyZXN1bHQpe1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcInJlc3VsdFwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYobGluZS5tYXRjaCgvXFxTKjouKjouKi8pKXtcbiAgICAgICAgY2FrZSA9IGxpbmUuc3BsaXQoXCI6XCIpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogXCJ3YXJuaW5nXCIsXG4gICAgICAgICAgICBwYXRoOiBjYWtlWzBdLFxuICAgICAgICAgICAgbGluZTogY2FrZVsxXSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGNha2Uuc2xpY2UoMikuam9pbihcIjpcIilcbiAgICAgICAgfVxuXG4gICAgfSBlbHNlIGlmKGxpbmUubWF0Y2goL2lleFxcKC8pKXtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IFwicmVzdWx0XCJcbiAgICAgICAgfVxuICAgIH0gZWxzZSByZXR1cm4gdW5kZWZpbmVkXG5cbn1cbmZ1bmN0aW9uIGRpYWx5emVNb2R1bGUobmFtZSwgY2IpIHtcbiAgICB2YXIgZGlhbFRlcm0gPSBwdHkuc3Bhd24oJ2RpYWx5emVyJywgW25hbWUsIFwiLS1xdWlldFwiXSwge1xuICAgICAgICBuYW1lOiAneHRlcm0tY29sb3InLFxuICAgICAgICBjb2xzOiA4MCxcbiAgICAgICAgcm93czogMzAsXG4gICAgICAgIGN3ZDogcHJvY2Vzcy5lbnYuSE9NRSxcbiAgICAgICAgZW52OiBwcm9jZXNzLmVudlxuICAgIH0pO1xuICAgIHZhciBsaW5lcyA9IFtdO1xuICAgIHZhciBhd2FpdERhdGEgPSBmdW5jdGlvbigpe1xuICAgICAgICBkaWFsVGVybS5vbihcImRhdGFcIiwgZnVuY3Rpb24oZGF0YSl7XG4gICAgICAgICAgICBkYXRhLnNwbGl0KFwiXFxuXCIpLm1hcChmdW5jdGlvbihsaW5lKXtcbiAgICAgICAgICAgICAgICBpZihsaW5lKWxpbmVzLnB1c2gocmVjb2duaXplRGlhbHl6ZXJMaW5lKGxpbmUpKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9O1xuICAgIGRpYWxUZXJtLm9uKFwiZXhpdFwiLCBmdW5jdGlvbigpe1xuICAgICAgICBjYihsaW5lcylcbiAgICB9KTtcbiAgICBkaWFsVGVybS5vbihcImVycm9yXCIsIGZ1bmN0aW9uKGUpe1xuICAgICAgICBjYih7ZXJyOiBlfSlcbiAgICB9KTtcblxuICAgIGF3YWl0RGF0YSgpXG59XG5mdW5jdGlvbiByZWNvZ25pemVEaWFseXplckxpbmUobGluZSl7XG4gICAgdmFyIGNha2UgPSBsaW5lLnNwbGl0KFwiOlwiKVxuICAgIHJldHVybiB7cGF0aDogY2FrZVswXSwgbGluZTogY2FrZVsxXSwgY29udGVudDogY2FrZS5zbGljZSgyKS5qb2luKFwiOlwiKX1cbn1cblxuZnVuY3Rpb24gaXNMaXN0KHcpe1xuICAgIHJldHVybiAvXFxTK1xccytcXFMrLy50ZXN0KHcpXG59XG4iXX0=